# 实施计划 - 可直接创建的 GitHub Issues

## Week 1: 核心转发 + 存储

### [Week1-1] 基础框架完善和依赖安装

**优先级**: P0
**预计时间**: 1 day

**任务**:
- [ ] 修复 go.mod 中的依赖版本
- [ ] 运行 `go mod tidy`
- [ ] 确保 `make build` 成功
- [ ] 添加 `.gitignore`（bin/, .env, vendor/）
- [ ] 配置 golangci-lint

**验收标准**:
- `make build` 无错误
- `make lint` 通过

---

### [Week1-2] 完善配置系统和验证

**优先级**: P0
**预计时间**: 0.5 day

**任务**:
- [ ] 测试配置加载（`LoadConfig`）
- [ ] 测试环境变量替换
- [ ] 添加配置验证的单元测试
- [ ] 处理边界情况（文件不存在、格式错误等）

**验收标准**:
- 配置加载测试覆盖率 > 80%
- 错误情况有清晰的错误信息

---

### [Week1-3] 实现 SSE 转发器

**优先级**: P0
**预计时间**: 2 days

**任务**:
- [ ] 完善 `forwardSSE` 逻辑
- [ ] 处理 `[DONE]` 标记
- [ ] 处理上游连接中断
- [ ] 处理客户端取消（context.Done）
- [ ] 添加 TTFT 计算
- [ ] 编写单元测试（mock HTTP response）

**验收标准**:
- 能正确转发 mock SSE 流
- TTFT 计算误差 < 10ms
- 客户端取消能立刻终止上游

**技术要点**:
```go
// 测试要覆盖的场景
- 正常流式响应
- 客户端中途断开
- 上游超时
- 上游返回错误
```

---

### [Week1-4] 实现 RAW 转发器

**优先级**: P0
**预计时间**: 1 day

**任务**:
- [ ] 完善 `forwardRaw` 逻辑
- [ ] TTFA 计算
- [ ] 处理大文件流（音频）
- [ ] 添加单元测试

**验收标准**:
- 能正确转发二进制流
- TTFA 计算正确
- 无内存泄漏

---

### [Week1-5] ClickHouse 集成和测试

**优先级**: P0
**预计时间**: 2 days

**任务**:
- [ ] 完善 `ensureTables` SQL
- [ ] 实现 `SaveLog` 写入
- [ ] 添加连接池配置
- [ ] 处理写入失败（日志记录）
- [ ] 编写集成测试（需要 Docker ClickHouse）

**验收标准**:
- 能成功创建表
- 能写入数据
- 能查询数据
- 写入失败有日志记录

**ClickHouse DDL 要点**:
```sql
-- 确保字段类型正确
- response_chunks Array(String) -- SSE 用
- ttft_ms Nullable(Int64)
- tokens_in/out Nullable(Int64)
```

---

### [Week1-6] 端到端测试

**优先级**: P1
**预计时间**: 1 day

**任务**:
- [ ] 启动完整服务（Docker + Relay）
- [ ] 测试 OpenAI SSE 转发
- [ ] 测试 TTS RAW 转发
- [ ] 验证 ClickHouse 数据正确性
- [ ] 验证 TTFT/TTFA 正确性

**验收标准**:
- 能完整转发 OpenAI 流式请求
- ClickHouse 有完整记录
- request_id 能对应查询

---

## Week 2: 观测 + 限流

### [Week2-1] Prometheus 指标集成

**优先级**: P0
**预计时间**: 1 day

**任务**:
- [ ] 完善 `metrics.go` 中的 5 个指标
- [ ] 在 `proxy.Handle` 中记录指标
- [ ] 测试 `/metrics` endpoint
- [ ] 验证 label 基数（不能爆炸）

**验收标准**:
- `/metrics` 能访问
- 发送请求后指标更新
- label 数量 < 100

---

### [Week2-2] 限流功能测试

**优先级**: P0
**预计时间**: 0.5 day

**任务**:
- [ ] 测试限流逻辑
- [ ] 验证 burst 机制
- [ ] 测试多租户隔离
- [ ] 添加限流被触发时的日志

**验收标准**:
- 超过限额返回 429
- 不同租户互不影响

---

### [Week2-3] Token 提取逻辑

**优先级**: P1
**预计时间**: 1.5 days

**任务**:
- [ ] 实现 `extractUsage` 函数
- [ ] 支持 OpenAI 格式
- [ ] 支持 Anthropic 格式
- [ ] 处理提取失败（返回 nil）
- [ ] 添加单元测试

**OpenAI 格式**:
```json
{
  "usage": {
    "prompt_tokens": 10,
    "completion_tokens": 20,
    "total_tokens": 30
  }
}
```

**Anthropic 格式**:
```json
{
  "usage": {
    "input_tokens": 10,
    "output_tokens": 20
  }
}
```

**验收标准**:
- 能正确提取 OpenAI usage
- 能正确提取 Anthropic usage
- 提取失败不影响转发

---

### [Week2-4] Grafana Dashboard

**优先级**: P1
**预计时间**: 1 day

**任务**:
- [ ] 创建基础 dashboard
- [ ] 面板：QPS（按 route）
- [ ] 面板：P95 延迟
- [ ] 面板：错误率
- [ ] 面板：活跃连接
- [ ] 导出 JSON

**验收标准**:
- Dashboard 能导入
- 数据显示正确

---

### [Week2-5] 告警规则

**优先级**: P1
**预计时间**: 0.5 day

**任务**:
- [ ] 编写 Prometheus 告警规则
- [ ] 错误率 > 2% 告警
- [ ] 活跃连接异常告警
- [ ] 存储写入失败告警

**验收标准**:
- 告警规则能加载
- 手动触发能告警

---

## Week 3: 生产就绪

### [Week3-1] 性能优化

**优先级**: P0
**预计时间**: 2 days

**任务**:
- [ ] 使用 pprof 分析性能
- [ ] 优化 HTTP client 连接池
- [ ] 优化内存分配（sync.Pool）
- [ ] 压测（wrk 或 locust）
- [ ] 调优 ClickHouse 写入

**性能目标**:
- 单机 QPS > 500
- P95 延迟 < 200ms（不含 LLM 生成时间）
- 内存稳定（无泄漏）

---

### [Week3-2] 错误处理完善

**优先级**: P0
**预计时间**: 1 day

**任务**:
- [ ] 完善所有错误类型
- [ ] 上游超时处理
- [ ] 上游 5xx 处理
- [ ] 客户端取消处理
- [ ] 存储失败重试（可选）

**错误类型**:
- `upstream_timeout`
- `upstream_5xx`
- `client_cancel`
- `storage_error`

---

### [Week3-3] 优雅关闭

**优先级**: P1
**预计时间**: 0.5 day

**任务**:
- [ ] 实现 `server.Shutdown`
- [ ] 等待活跃请求完成
- [ ] 关闭 ClickHouse 连接
- [ ] 关闭 Redis 连接
- [ ] 测试信号处理（SIGINT/SIGTERM）

**验收标准**:
- Ctrl+C 能优雅关闭
- 不丢失正在处理的请求

---

### [Week3-4] 部署文档和运维

**优先级**: P1
**预计时间**: 1 day

**任务**:
- [ ] 编写 Dockerfile
- [ ] 编写 K8s manifests（可选）
- [ ] 编写运维文档
- [ ] 常见问题排查
- [ ] 备份和恢复流程

**文档包含**:
- 部署步骤
- 配置说明
- 监控指标说明
- 常见问题排查

---

### [Week3-5] 生产验证

**优先级**: P0
**预计时间**: 1 day

**任务**:
- [ ] 小流量灰度测试
- [ ] 验证所有功能正常
- [ ] 验证监控告警
- [ ] 验证数据正确性
- [ ] 性能压测

**验收标准**:
- 灰度环境运行 24h 无问题
- 错误率 < 0.1%
- 数据完整性 100%

---

## 可选优化（V2）

这些功能等 V1 稳定后再考虑：

### [V2-1] 异步写入优化（如果性能不够）

**条件**: 单机 QPS 无法达到 500

**任务**:
- [ ] 实现异步队列
- [ ] 批量写入 ClickHouse
- [ ] 队列满时策略

---

### [V2-2] 熔断机制（如果上游不稳定）

**条件**: 上游频繁 5xx

**任务**:
- [ ] 实现熔断器
- [ ] 按 provider 隔离
- [ ] 半开状态探测

---

### [V2-3] 灰度路由（如果需要多上游）

**条件**: 需要同时使用多个 provider

**任务**:
- [ ] 权重路由
- [ ] Fallback 机制
- [ ] 健康检查

---

### [V2-4] 本地 Tokenizer（如果 usage 提取率低）

**条件**: usage 提取成功率 < 95%

**任务**:
- [ ] 集成 tiktoken-go
- [ ] 只对白名单模型启用
- [ ] 对比准确度

---

## 总结

**强制执行顺序：Week1 → Week2 → Week3**

**关键里程碑**:
- Week1 结束：能转发并存储
- Week2 结束：有监控和限流
- Week3 结束：生产可用

**核心原则**:
- 先做确实需要的，不做"可能需要"的
- V2 功能等 V1 跑稳后再决定

祝开发顺利！
